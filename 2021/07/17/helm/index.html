<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"stupid-yu.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"4VZM63UWRF","apiKey":"98a8dc33ac682bbdd7a212e3f0aba3a8","indexName":"blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="为什么需要Helm？K8S上的应用对象，都是由特定的资源描述组成，包括deployment、service等。都保存各自文件中或者集中写到一个配置文件。然后kubectl apply –f 部署。  如果应用只由一个或几个这样的服务组成，上面部署方式足够了。 而对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。如果有更新或回滚应用的需求，可">
<meta property="og:type" content="article">
<meta property="og:title" content="Helm应用包管理器">
<meta property="og:url" content="https://stupid-yu.github.io/2021/07/17/helm/index.html">
<meta property="og:site_name" content="Yu&#39;s blog">
<meta property="og:description" content="为什么需要Helm？K8S上的应用对象，都是由特定的资源描述组成，包括deployment、service等。都保存各自文件中或者集中写到一个配置文件。然后kubectl apply –f 部署。  如果应用只由一个或几个这样的服务组成，上面部署方式足够了。 而对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。如果有更新或回滚应用的需求，可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-vs-yaml.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-arch.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-set-usage.png">
<meta property="article:published_time" content="2021-07-17T09:30:18.000Z">
<meta property="article:modified_time" content="2021-11-30T02:58:59.403Z">
<meta property="article:author" content="Yu Hui">
<meta property="article:tag" content="helm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-vs-yaml.png">

<link rel="canonical" href="https://stupid-yu.github.io/2021/07/17/helm/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Helm应用包管理器 | Yu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yu's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习 & 记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-k8s">

    <a href="/tags/k8s/" rel="section"><i class="fab fa-connectdevelop fa-fw"></i>k8s</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/stupid-yu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://stupid-yu.github.io/2021/07/17/helm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu Hui">
      <meta itemprop="description" content="蠢鱼蠢鱼，上班摸鱼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yu's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Helm应用包管理器
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 17:30:18" itemprop="dateCreated datePublished" datetime="2021-07-17T17:30:18+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-30 10:58:59" itemprop="dateModified" datetime="2021-11-30T10:58:59+08:00">2021-11-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          
            <span id="/2021/07/17/helm/" class="post-meta-item leancloud_visitors" data-flag-title="Helm应用包管理器" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/07/17/helm/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/17/helm/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="为什么需要Helm？"><a href="#为什么需要Helm？" class="headerlink" title="为什么需要Helm？"></a>为什么需要Helm？</h2><p>K8S上的应用对象，都是由特定的资源描述组成，包括deployment、service等。都保存各自文件中或者集中写到一个配置文件。然后kubectl apply –f 部署。</p>
<p><img src="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-vs-yaml.png"></p>
<p>如果应用只由一个或几个这样的服务组成，上面部署方式足够了。</p>
<p>而对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。如果有更新或回滚应用的需求，可能要修改和维护所涉及的大量资源文件，而这种组织和管理应用的方式就显得力不从心了。</p>
<p>且由于缺少对发布过的应用版本管理和控制，使Kubernetes上的应用维护和更新等面临诸多的挑战，主要面临以下问题：</p>
<ul>
<li><p><strong>如何将这些服务作为一个整体管理</strong></p>
</li>
<li><p><strong>这些资源文件如何高效复用</strong></p>
</li>
<li><p><strong>不支持应用级别的版本管理</strong></p>
</li>
</ul>
<span id="more"></span>

<h2 id="Helm-介绍"><a href="#Helm-介绍" class="headerlink" title="Helm 介绍"></a>Helm 介绍</h2><p>Helm是一个Kubernetes的包管理工具，就像Linux下的包管理器，如yum/apt等，可以很方便的将之前打包好的yaml文件部署到kubernetes上。</p>
<p>Helm有两个重要概念：</p>
<ul>
<li><p><strong>helm：</strong> 一个命令行客户端工具，主要用于Kubernetes应用chart的创建、打包、发布和管理。</p>
</li>
<li><p><strong>Chart：</strong> 应用描述，一系列用于描述 k8s 资源相关文件的集合。</p>
</li>
<li><p><strong>Release：</strong> 基于Chart的部署实体，一个 chart 被 Helm 运行后将会生成对应的一个 release；将在k8s中创建出真实运行的资源对象。</p>
</li>
</ul>
<h2 id="Helm-v3-变化"><a href="#Helm-v3-变化" class="headerlink" title="Helm v3 变化"></a>Helm v3 变化</h2><p><strong>2019年11月13日，</strong> Helm团队发布 <code>Helm v3 </code>的第一个稳定版本。</p>
<p><strong>该版本主要变化如下：</strong></p>
<h3 id="架构变化"><a href="#架构变化" class="headerlink" title="架构变化"></a>架构变化</h3><p><strong>最明显的变化是 <code>Tiller </code>的删除</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-arch.png"></p>
<h3 id="Release名称可以在不同命名空间重用"><a href="#Release名称可以在不同命名空间重用" class="headerlink" title="Release名称可以在不同命名空间重用"></a><code>Release</code>名称可以在不同命名空间重用</h3><h3 id="支持将-Chart-推送至-Docker-镜像仓库中"><a href="#支持将-Chart-推送至-Docker-镜像仓库中" class="headerlink" title="支持将 Chart 推送至 Docker 镜像仓库中"></a>支持将 Chart 推送至 Docker 镜像仓库中</h3><h3 id="使用JSONSchema验证chart-values"><a href="#使用JSONSchema验证chart-values" class="headerlink" title="使用JSONSchema验证chart values"></a>使用JSONSchema验证chart values</h3><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>1）为了更好地协调其他包管理者的措辞 <code>Helm CLI </code>个别更名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm delete` 更名为 `helm uninstall</span><br><span class="line">helm inspect` 更名为 `helm show</span><br><span class="line">helm fetch` 更名为 `helm pull</span><br></pre></td></tr></table></figure>

<p>但以上旧的命令当前仍能使用。</p>
<p>2）移除了用于本地临时搭建 <code>Chart Repository </code>的 <code>helm serve</code> 命令。</p>
<p>3）自动创建名称空间</p>
<p>在不存在的命名空间中创建发行版时，Helm 2创建了命名空间。Helm 3遵循其他Kubernetes对象的行为，如果命名空间不存在则返回错误。</p>
<p>4） 不再需要<code>requirements.yaml</code>, 依赖关系是直接在<code>chart.yaml</code>中定义。 </p>
<h2 id="Helm客户端"><a href="#Helm客户端" class="headerlink" title="Helm客户端"></a>Helm客户端</h2><h3 id="部署Helm客户端"><a href="#部署Helm客户端" class="headerlink" title="部署Helm客户端"></a>部署Helm客户端</h3><p>Helm客户端下载地址：<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></p>
<p>解压移动到/usr/bin/目录即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#目前最新版 3.6.0</span><br><span class="line">wget https://get.helm.sh/helm-v3.6.0-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v3.6.0-linux-amd64.tar.gz </span><br><span class="line">mv linux-amd64/helm /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="Helm常用命令"><a href="#Helm常用命令" class="headerlink" title="Helm常用命令"></a>Helm常用命令</h3><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>create</td>
<td>创建一个chart并指定名字</td>
</tr>
<tr>
<td>dependency</td>
<td>管理chart依赖</td>
</tr>
<tr>
<td>get</td>
<td>下载一个release。可用子命令：all、hooks、manifest、notes、values</td>
</tr>
<tr>
<td>history</td>
<td>获取release历史</td>
</tr>
<tr>
<td>install</td>
<td>安装一个chart</td>
</tr>
<tr>
<td>list</td>
<td>列出release</td>
</tr>
<tr>
<td>package</td>
<td>将chart目录打包到chart存档文件中</td>
</tr>
<tr>
<td>pull</td>
<td>从远程仓库中下载chart并解压到本地  # helm pull stable/mysql –untar</td>
</tr>
<tr>
<td>repo</td>
<td>添加，列出，移除，更新和索引chart仓库。可用子命令：add、index、list、remove、update</td>
</tr>
<tr>
<td>rollback</td>
<td>从之前版本回滚</td>
</tr>
<tr>
<td>search</td>
<td>根据关键字搜索chart。可用子命令：hub、repo</td>
</tr>
<tr>
<td>show</td>
<td>查看chart详细信息。可用子命令：all、chart、readme、values</td>
</tr>
<tr>
<td>status</td>
<td>显示已命名版本的状态</td>
</tr>
<tr>
<td>template</td>
<td>本地呈现模板</td>
</tr>
<tr>
<td>uninstall</td>
<td>卸载一个release</td>
</tr>
<tr>
<td>upgrade</td>
<td>更新一个release</td>
</tr>
<tr>
<td>version</td>
<td>查看helm客户端版本</td>
</tr>
</tbody></table>
<h3 id="配置国内Chart仓库"><a href="#配置国内Chart仓库" class="headerlink" title="配置国内Chart仓库"></a>配置国内Chart仓库</h3><ul>
<li>微软仓库（<a target="_blank" rel="noopener" href="http://mirror.azure.cn/kubernetes/charts/">http://mirror.azure.cn/kubernetes/charts/</a>) 这个仓库强烈推荐，基本上官网有的chart这里都有。</li>
<li>阿里云仓库（<a target="_blank" rel="noopener" href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts">https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</a>) 长时间未更新，版本较旧</li>
<li>官方仓库（<a target="_blank" rel="noopener" href="https://hub.kubeapps.com/charts/incubator">https://hub.kubeapps.com/charts/incubator</a>) 官方chart仓库，国内有点不好使。</li>
<li>可以参考 <a target="_blank" rel="noopener" href="https://github.com/BurdenBear/kube-charts-mirror">kube-charts-mirror</a>，搭建一个自主可控的镜像源。</li>
</ul>
<p>添加存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>

<p>查看配置的存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br><span class="line">helm search repo stable</span><br></pre></td></tr></table></figure>

<p>一直在stable存储库中安装charts，你可以配置其他存储库。</p>
<p>删除存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo remove aliyun</span><br></pre></td></tr></table></figure>

<h2 id="Helm基本使用"><a href="#Helm基本使用" class="headerlink" title="Helm基本使用"></a>Helm基本使用</h2><p>主要介绍三个命令：</p>
<ul>
<li><p>chart install</p>
</li>
<li><p>chart update</p>
</li>
<li><p>chart rollback</p>
</li>
</ul>
<h3 id="使用chart部署一个应用"><a href="#使用chart部署一个应用" class="headerlink" title="使用chart部署一个应用"></a>使用chart部署一个应用</h3><p>查找chart：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># helm search repo</span><br><span class="line"># helm search repo mysql</span><br></pre></td></tr></table></figure>

<p>为什么mariadb也在列表中？因为他和mysql有关。</p>
<p>查看chart信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm show chart stable/mysql</span><br></pre></td></tr></table></figure>

<p>安装包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install db stable/mysql</span><br></pre></td></tr></table></figure>

<p>查看发布状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm status db </span><br></pre></td></tr></table></figure>

<h3 id="安装前自定义chart配置选项"><a href="#安装前自定义chart配置选项" class="headerlink" title="安装前自定义chart配置选项"></a>安装前自定义chart配置选项</h3><p>上面部署的mysql并没有成功，这是因为并不是所有的chart都能按照默认配置运行成功，可能会需要一些环境依赖，例如PV。</p>
<p>所以我们需要自定义chart配置选项，安装过程中有两种方法可以传递配置数据：</p>
<ul>
<li>–values（或-f）：指定带有覆盖的YAML文件。这可以多次指定，最右边的文件优先</li>
<li>–set：在命令行上指定替代。如果两者都用，–set优先级高</li>
</ul>
<p>–values使用，先将修改的变量写到一个文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># helm show values stable/mysql</span><br><span class="line"># cat config.yaml </span><br><span class="line">persistence:  </span><br><span class="line">  enabled: true  </span><br><span class="line">  storageClass: &quot;managed-nfs-storage&quot;  </span><br><span class="line">  accessMode: ReadWriteOnce  </span><br><span class="line">  size: 8Gi</span><br><span class="line">  mysqlUser: &quot;k8s&quot;</span><br><span class="line">  mysqlPassword: &quot;123456&quot;</span><br><span class="line">  mysqlDatabase: &quot;k8s&quot;</span><br><span class="line">  </span><br><span class="line"># helm install db -f config.yaml stable/mysql</span><br><span class="line"># kubectl get pods</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">db-mysql-57485b68dc-4xjhv        1/1     Running   0          8m51s</span><br></pre></td></tr></table></figure>

<p>以上将创建具有名称的默认MySQL用户k8s，并授予此用户访问新创建的k8s数据库的权限，但将接受该图表的所有其余默认值。</p>
<p>命令行替代变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install db --set persistence.storageClass=&quot;managed-nfs-storage&quot; stable/mysql</span><br></pre></td></tr></table></figure>

<p>也可以把chart包下载下来查看详情：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm pull stable/mysql --untar</span><br></pre></td></tr></table></figure>

<p>values yaml与set使用：</p>
<p><img src="https://cdn.jsdelivr.net/gh/stupid-yu/cdn/img/helm-set-usage.png"></p>
<p><strong>该helm install命令可以从多个来源安装：</strong></p>
<ul>
<li>chart存储库</li>
<li>本地chart存档（helm install foo-0.1.1.tgz）</li>
<li>chart目录（helm install path/to/foo）</li>
<li>完整的URL（helm install <a target="_blank" rel="noopener" href="https://example.com/charts/foo-1.2.3.tgz%EF%BC%89">https://example.com/charts/foo-1.2.3.tgz）</a></li>
</ul>
<h3 id="构建一个Helm-Chart"><a href="#构建一个Helm-Chart" class="headerlink" title="构建一个Helm Chart"></a>构建一个Helm Chart</h3><p>自动生成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line"># tree mychart/</span><br><span class="line">mychart/</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml          </span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   └── service.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>Chart.yaml：用于描述这个 Chart的基本信息，包括名字、描述信息以及版本等。</li>
<li>values.yaml ：用于存储 templates 目录中模板文件中用到变量的值。</li>
<li>Templates： 目录里面存放所有yaml模板文件。</li>
<li>charts：目录里存放这个chart依赖的所有子chart。</li>
<li>NOTES.txt ：用于介绍Chart帮助信息， helm install 部署后展示给用户。例如：如何使用这个 Chart、列出缺省的设置等。</li>
<li>_helpers.tpl：放置模板助手的地方，可以在整个 chart 中重复使用</li>
</ul>
<p>创建Chart后，接下来就是将其部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install web mychart/</span><br></pre></td></tr></table></figure>

<p>也可以打包推送的charts仓库共享别人使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm package mychart/mychart-0.1.0.tgz</span><br></pre></td></tr></table></figure>

<h3 id="升级、回滚和删除"><a href="#升级、回滚和删除" class="headerlink" title="升级、回滚和删除"></a>升级、回滚和删除</h3><p>发布新版本的chart时，或者当您要更改发布的配置时，可以使用该<code>helm upgrade</code> 命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># helm upgrade --set imageTag=1.17 web mychart</span><br><span class="line"># helm upgrade -f values.yaml web mychart</span><br></pre></td></tr></table></figure>

<p>如果在发布后没有达到预期的效果，则可以使用<code>helm rollback </code>回滚到之前的版本。</p>
<p>例如将应用回滚到第一个版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm rollback web 2</span><br></pre></td></tr></table></figure>

<p>卸载发行版，请使用以下<code>helm uninstall</code>命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm uninstall web</span><br></pre></td></tr></table></figure>

<p>查看历史版本配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm get --revision 1 web</span><br></pre></td></tr></table></figure>

<h2 id="Chart模板"><a href="#Chart模板" class="headerlink" title="Chart模板"></a>Chart模板</h2><p>Helm最核心的就是模板，即模板化的K8S manifests文件。</p>
<p>它本质上就是一个Go的template模板。Helm在Go template模板的基础上，还会增加很多东西。如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>有了模板，我们怎么把我们的配置融入进去呢？用的就是这个values文件。这两部分内容其实就是chart的核心功能。</p>
<p>接下来，部署nginx应用，熟悉模板使用，先把templates 目录下面所有文件全部删除掉，这里我们自己来创建模板文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># rm -rf mychart/templates/*</span><br><span class="line"># vi templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>

<p>实际上，这已经是一个可安装的Chart包了，通过 <code>helm install</code>命令来进行安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install web mychart</span><br></pre></td></tr></table></figure>

<p>这样部署，其实与直接apply没什么两样。</p>
<p>然后使用如下命令可以看到实际的模板被渲染过后的资源文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm get manifest web</span><br></pre></td></tr></table></figure>

<p>可以看到，这与刚开始写的内容是一样的，包括名字、镜像等，我们希望能在一个地方统一定义这些会经常变换的字段，这就需要用到Chart的模板了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># vi templates/deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>

<p>这个deployment就是一个Go template的模板，这里定义的Release模板对象属于Helm内置的一种对象，是从values文件中读取出来的。这样一来，我们可以将需要变化的地方都定义变量。</p>
<p>再执行helm install chart 可以看到现在生成的名称变成了<strong>web-deployment</strong>，证明已经生效了。也可以使用命令helm get manifest查看最终生成的文件内容。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>Helm也提供了<code>--dry-run --debug</code>调试参数，帮助你验证模板正确性。在执行<code>helm install</code>时候带上这两个参数就可以把对应的values值和渲染的资源清单打印出来，而不会真正的去部署一个release。</p>
<p>比如我们来调试上面创建的 chart 包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install web2 --dry-run /root/mychart</span><br></pre></td></tr></table></figure>

<h3 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h3><p>刚刚我们使用 <code>&#123;&#123;.Release.Name&#125;&#125;</code>将 release 的名称插入到模板中。这里的 Release 就是 Helm 的内置对象，下面是一些常用的内置对象：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Release.Name</td>
<td>release 名称</td>
</tr>
<tr>
<td>Release.Namespace</td>
<td>release 命名空间</td>
</tr>
<tr>
<td>Release.Service</td>
<td>release 服务的名称</td>
</tr>
<tr>
<td>Release.Revision</td>
<td>release 修订版本号，从1开始累加</td>
</tr>
</tbody></table>
<h3 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h3><p>Values对象是为Chart模板提供值，这个对象的值有4个来源：</p>
<ul>
<li><p>chart 包中的 values.yaml 文件</p>
</li>
<li><p>父 chart 包的 values.yaml 文件</p>
</li>
<li><p>通过 helm install 或者 helm upgrade 的 <code>-f</code>或者 <code>--values</code>参数传入的自定义的 yaml 文件</p>
</li>
<li><p>通过 <code>--set</code> 参数传入的值</p>
</li>
</ul>
<p>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以被 <code>--set</code>提供的参数所覆盖。</p>
<p>这里我们来重新编辑 mychart/values.yaml 文件，将默认的值全部清空，然后添加一个副本数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">replicas: 3</span><br><span class="line">image: &quot;nginx&quot;</span><br><span class="line">imageTag: &quot;1.17&quot;</span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125;</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>

<p>查看渲染结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install --dry-run web ../mychart/</span><br></pre></td></tr></table></figure>

<p>values 文件也可以包含结构化内容，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">...</span><br><span class="line">label:  </span><br><span class="line">  project: ms  </span><br><span class="line">  app: nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment </span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas &#125;&#125; </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      project: &#123;&#123; .Values.label.project &#125;&#125;</span><br><span class="line">      app: &#123;&#123; .Values.label.app &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        project: &#123;&#123; .Values.label.project &#125;&#125;</span><br><span class="line">        app: &#123;&#123; .Values.label.app &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125; </span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>

<p>查看渲染结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># helm install --dry-run web ../mychart/</span><br></pre></td></tr></table></figure>

<h3 id="管道与函数"><a href="#管道与函数" class="headerlink" title="管道与函数"></a>管道与函数</h3><p>前面讲的模块，其实就是将值传给模板引擎进行渲染，模板引擎还支持对拿到数据进行二次处理。</p>
<p>例如从.Values中读取的值变成字符串，可以使用<code>quote</code>函数实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi templates/deployment.yaml</span><br><span class="line">app: &#123;&#123; quote .Values.label.app &#125;&#125;</span><br><span class="line"></span><br><span class="line"># helm install --dry-run web ../mychart/ </span><br><span class="line">        project: ms</span><br><span class="line">        app: &quot;nginx&quot;</span><br></pre></td></tr></table></figure>

<p>quote .Values.label.app 将后面的值作为参数传递给quote函数。</p>
<p>模板函数调用语法为：functionName arg1 arg2…</p>
<p>另外还会经常使用一个default函数，该函数允许在模板中指定默认值，以防止该值被忽略掉。</p>
<p>例如忘记定义，执行helm install 会因为缺少字段无法创建资源，这时就可以定义一个默认值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">replicas: 2</span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:  </span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- name: &#123;&#123; .Values.name | default &quot;nginx&quot; &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>其他函数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">缩进：&#123;&#123; .Values.resources | indent 12 &#125;&#125;</span><br><span class="line"></span><br><span class="line">大写：&#123;&#123; upper .Values.resources &#125;&#125;</span><br><span class="line"></span><br><span class="line">首字母大写：&#123;&#123; title .Values.resources &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><p>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理。</p>
<p>Helm模板语言提供以下流程控制语句：</p>
<ul>
<li><code>if/else</code> 条件块</li>
<li><code>with</code> 指定范围</li>
<li><code>range</code> 循环块</li>
</ul>
<h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><p><code>if/else</code>块是用于在模板中有条件地包含文本块的方法，条件块的基本结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if PIPELINE &#125;&#125;</span><br><span class="line">  # Do something</span><br><span class="line">&#123;&#123; else if OTHER PIPELINE &#125;&#125;</span><br><span class="line">  # Do something else</span><br><span class="line">&#123;&#123; else &#125;&#125;</span><br><span class="line">  # Default case</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">devops: k8</span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">...</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        &#123;&#123; if eq .Values.devops &quot;k8s&quot; &#125;&#125;</span><br><span class="line">        devops: 123</span><br><span class="line">        &#123;&#123; else &#125;&#125;</span><br><span class="line">        devops: 456</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在上面条件语句使用了<code>eq</code>运算符判断是否相等，除此之外，还支持<code>ne</code>、 <code>lt</code>、 <code>gt</code>、 <code>and</code>、 <code>or</code>等运算符。</p>
<p>通过模板引擎来渲染一下，会得到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># helm install --dry-run web ../mychart/ </span><br><span class="line">...</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx  </span><br><span class="line">        devops: 456      </span><br></pre></td></tr></table></figure>

<p>可以看到渲染出来会有多余的空行，这是因为当模板引擎运行时，会将控制指令删除，所有之前占的位置也就空白了，需要使用<code>&#123;&#123;- if ...&#125;&#125; </code>的方式消除此空行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cat templates/deploymemt.yaml</span><br><span class="line">...</span><br><span class="line">        env:</span><br><span class="line">        &#123;&#123;- if eq .Values.env.hello &quot;world&quot; &#125;&#125;</span><br><span class="line">          - name: hello</span><br><span class="line">            value: 123</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>现在是不是没有多余的空格了，如果使用<code>-&#125;&#125;</code>需谨慎，比如上面模板文件中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cat templates/deploymemt.yaml</span><br><span class="line">...</span><br><span class="line">       env:</span><br><span class="line">        &#123;&#123;- if eq .Values.env.hello &quot;world&quot; -&#125;&#125;</span><br><span class="line">           - hello: true</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这会渲染成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env:- hello: true</span><br></pre></td></tr></table></figure>

<p>因为<code>-&#125;&#125;</code>它删除了双方的换行符。</p>
<p>条件判断就是判断条件是否为真，如果值为以下几种情况则为false：</p>
<ul>
<li><p>一个布尔类型的 <code>假</code></p>
</li>
<li><p>一个数字 <code>零</code></p>
</li>
<li><p>一个 <code>空</code>的字符串</p>
</li>
<li><p>一个 <code>nil</code>（空或 <code>null</code>）</p>
</li>
<li><p>一个空的集合（ <code>map</code>、 <code>slice</code>、 <code>tuple</code>、 <code>dict</code>、 <code>array</code>）</p>
</li>
</ul>
<p>除了上面的这些情况外，其他所有条件都为 <code>真</code>。</p>
<p>例如，判断一个空的数组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">  # limits:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cat templates/deploymemt.yaml</span><br><span class="line">...</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: nginx</span><br><span class="line">        &#123;&#123;- if .Values.resources &#125;&#125;</span><br><span class="line">        resources:</span><br><span class="line">&#123;&#123; toYaml .Values.resources | indent 10 &#125;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>例如，判断一个布尔值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: true </span><br><span class="line">  host: example.ctnrs.com</span><br><span class="line"></span><br><span class="line"># cat templates/ingress.yaml </span><br><span class="line">&#123;&#123;- if .Values.ingress.enabled -&#125;&#125;</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: &#123;&#123; .Values.ingress.host &#125;&#125;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">          servicePort: &#123;&#123; .Values.service.port &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="with"><a href="#with" class="headerlink" title="with"></a>with</h4><p>with ：控制变量作用域。</p>
<p>还记得之前我们的 <code>&#123;&#123;.Release.xxx&#125;&#125;</code>或者 <code>&#123;&#123;.Values.xxx&#125;&#125;</code>吗？其中的 <code>.</code>就是表示对当前范围的引用， <code>.Values</code>就是告诉模板在当前范围中查找 <code>Values</code>对象的值。而 <code>with</code>语句就可以来控制变量的作用域范围，其语法和一个简单的 <code>if</code>语句比较类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; with PIPELINE &#125;&#125;</span><br><span class="line">  #  restricted scope</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>with</code>语句可以允许将当前范围 <code>.</code>设置为特定的对象，比如我们前面一直使用的 <code>.Values.label</code>，我们可以使用 <code>with</code>来将 <code>.</code>范围指向 <code>.Values.label</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">...</span><br><span class="line">replicas: 3</span><br><span class="line">label:</span><br><span class="line">  project: ms</span><br><span class="line">  app: nginx</span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        team: &#123;&#123; .team &#125;&#125;</span><br><span class="line">        gpu: &#123;&#123; .gpu &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">nodeSelector:</span><br><span class="line">  &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>上面增加了一个 xxx的一个块，这样的话就可以在当前的块里面直接引用 <code>.team</code>和 <code>.gpu</code>了。</p>
<p> <strong>with</strong>是一个循环构造。使用**.Values.nodeSelector中**的值：将其转换为Yaml。 </p>
<p> toYaml之后的点是循环中**.Values.nodeSelector**的当前值 </p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p>在 Helm 模板语言中，使用 <code>range</code>关键字来进行循环操作。</p>
<p>我们在 <code>values.yaml</code>文件中添加上一个变量列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">test:</span><br><span class="line">  - 1</span><br><span class="line">  - 2</span><br><span class="line">  - 3</span><br></pre></td></tr></table></figure>

<p>循环打印该列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">data:</span><br><span class="line">  test: |</span><br><span class="line">  &#123;&#123;- range .Values.test &#125;&#125;</span><br><span class="line">    &#123;&#123; . &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>循环内部我们使用的是一个 <code>.</code>，这是因为当前的作用域就在当前循环内，这个 <code>.</code>引用的当前读取的元素。</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>接下来学习一个语言中基本的概念：<strong>变量</strong>，在模板中，使用变量的场合不多，但我们将看到如何使用它来简化代码，并更好地利用with和range。</p>
<p><strong>问题1：获取列表键值</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># cat ../values.yaml</span><br><span class="line">env:</span><br><span class="line">  NAME: &quot;gateway&quot;</span><br><span class="line">  JAVA_OPTS: &quot;-Xmx1G&quot;</span><br><span class="line"> </span><br><span class="line"># cat deployment.yaml </span><br><span class="line">...</span><br><span class="line">env:</span><br><span class="line">&#123;&#123;- range $k, $v := .Values.env &#125;&#125;</span><br><span class="line">  - name: &#123;&#123; $k &#125;&#125;</span><br><span class="line">    value: &#123;&#123; $v | quote &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">- name: JAVA_OPTS</span><br><span class="line">  value: &quot;-Xmx1G&quot;</span><br><span class="line">- name: NAME</span><br><span class="line">  value: &quot;gateway&quot;</span><br></pre></td></tr></table></figure>

<p>上面在 <code>range</code>循环中使用 <code>$key</code>和 <code>$value</code>两个变量来接收后面列表循环的键和值<code>。</code></p>
<p><strong>问题2：with中不能使用内置对象</strong></p>
<p><code>with</code>语句块内不能再 <code>.Release.Name</code>对象，否则报错。</p>
<p>我们可以将该对象赋值给一个变量可以来解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        project: &#123;&#123; .Values.label.project &#125;&#125;</span><br><span class="line">        app: &#123;&#123; quote .Values.label.app &#125;&#125;</span><br><span class="line">      &#123;&#123;- with .Values.label &#125;&#125;</span><br><span class="line">        project: &#123;&#123; .project &#125;&#125;</span><br><span class="line">        app: &#123;&#123; .app &#125;&#125;</span><br><span class="line">        release: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>上面会出错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- $releaseName := .Release.Name -&#125;&#125;</span><br><span class="line">&#123;&#123;- with .Values.label &#125;&#125;</span><br><span class="line">  project: &#123;&#123; .project &#125;&#125;</span><br><span class="line">  app: &#123;&#123; .app &#125;&#125;</span><br><span class="line">  release: &#123;&#123; $releaseName &#125;&#125;</span><br><span class="line">  # 或者可以使用$符号,引入全局命名空间</span><br><span class="line">  release: &#123;&#123; $.Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在 <code>with</code>语句上面增加了一句 <code>&#123;&#123;-$releaseName:=.Release.Name-&#125;&#125;</code>，其中 <code>$releaseName</code>就是后面的对象的一个引用变量，它的形式就是 <code>$name</code>，赋值操作使用 <code>:=</code>，这样 <code>with</code>语句块内部的 <code>$releaseName</code>变量仍然指向的是 <code>.Release.Name</code></p>
<h3 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h3><p>命名模板：使用define定义，template引入，在templates目录中默认下划线_开头的文件为公共模板(_helpers.tpl)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># cat _helpers.tpl</span><br><span class="line">&#123;&#123;- define &quot;demo.fullname&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- .Chart.Name -&#125;&#125;-&#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line"># cat deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template &quot;demo.fullname&quot; . &#125;&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>template指令是将一个模板包含在另一个模板中的方法。但是，template函数不能用于Go模板管道。为了解决该问题，增加include功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># cat _helpers.tpl</span><br><span class="line">&#123;&#123;- define &quot;demo.labels&quot; -&#125;&#125;</span><br><span class="line">app: &#123;&#123; template &quot;demo.fullname&quot; . &#125;&#125;</span><br><span class="line">chart: &quot;&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class="line">release: &quot;&#123;&#123; .Release.Name &#125;&#125;&quot;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line"># cat deployment.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; include &quot;demo.fullname&quot; . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    &#123;&#123;- include &quot;demo.labels&quot; . | nindent 4 &#125;&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>上面包含一个名为 <code>demo.labels</code> 的模板，然后将值 <code>.</code> 传递给模板，最后将该模板的输出传递给 <code>nindent</code> 函数。</p>
<h2 id="开发自己的Chart：Java应用为例"><a href="#开发自己的Chart：Java应用为例" class="headerlink" title="开发自己的Chart：Java应用为例"></a>开发自己的Chart：Java应用为例</h2><ol>
<li><p>先创建模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create demo</span><br></pre></td></tr></table></figure></li>
<li><p>修改Chart.yaml，Values.yaml，添加常用的变量</p>
</li>
<li><p>在templates目录下创建部署镜像所需要的yaml文件，并变量引用yaml里经常变动的字段</p>
</li>
</ol>
<h2 id="使用Harbor作为Chart仓库"><a href="#使用Harbor作为Chart仓库" class="headerlink" title="使用Harbor作为Chart仓库"></a>使用Harbor作为Chart仓库</h2><p><strong>1、启用Harbor的Chart仓库服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ./install.sh --with-chartmuseum</span><br></pre></td></tr></table></figure>

<p>启用后，默认创建的项目就带有helm charts功能了。</p>
<p><strong>2、安装push插件</strong></p>
<p> <a target="_blank" rel="noopener" href="https://github.com/chartmuseum/helm-push">https://github.com/chartmuseum/helm-push</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm plugin install https://github.com/chartmuseum/helm-push</span><br></pre></td></tr></table></figure>

<p><strong>3、添加repo</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add  --username admin --password Harbor12345 myrepo http://192.168.31.70/chartrepo/library</span><br></pre></td></tr></table></figure>

<p><strong>4、推送与安装Chart</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># helm push mysql-1.4.0.tgz --username=admin --password=Harbor12345 http://192.168.31.70/chartrepo/library</span><br><span class="line"># helm install web --version 1.4.0 myrepo/demo</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Yu Hui
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://stupid-yu.github.io/2021/07/17/helm/" title="Helm应用包管理器">https://stupid-yu.github.io/2021/07/17/helm/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/helm/" rel="tag"># helm</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/13/hexo-next-github/" rel="prev" title="github pages & hexo 搭建个人博客">
      <i class="fa fa-chevron-left"></i> github pages & hexo 搭建个人博客
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/27/oracle/" rel="next" title="oracle">
      oracle <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Helm%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">为什么需要Helm？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">Helm 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-v3-%E5%8F%98%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">Helm v3 变化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E5%8F%98%E5%8C%96"><span class="nav-number">3.1.</span> <span class="nav-text">架构变化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Release%E5%90%8D%E7%A7%B0%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%87%8D%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">Release名称可以在不同命名空间重用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E5%B0%86-Chart-%E6%8E%A8%E9%80%81%E8%87%B3-Docker-%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E4%B8%AD"><span class="nav-number">3.3.</span> <span class="nav-text">支持将 Chart 推送至 Docker 镜像仓库中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8JSONSchema%E9%AA%8C%E8%AF%81chart-values"><span class="nav-number">3.4.</span> <span class="nav-text">使用JSONSchema验证chart values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">3.5.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.</span> <span class="nav-text">Helm客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Helm%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">4.1.</span> <span class="nav-text">部署Helm客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Helm%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.</span> <span class="nav-text">Helm常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85Chart%E4%BB%93%E5%BA%93"><span class="nav-number">4.3.</span> <span class="nav-text">配置国内Chart仓库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">Helm基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8chart%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8"><span class="nav-number">5.1.</span> <span class="nav-text">使用chart部署一个应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%89%8D%E8%87%AA%E5%AE%9A%E4%B9%89chart%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="nav-number">5.2.</span> <span class="nav-text">安装前自定义chart配置选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAHelm-Chart"><span class="nav-number">5.3.</span> <span class="nav-text">构建一个Helm Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E3%80%81%E5%9B%9E%E6%BB%9A%E5%92%8C%E5%88%A0%E9%99%A4"><span class="nav-number">5.4.</span> <span class="nav-text">升级、回滚和删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chart%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.</span> <span class="nav-text">Chart模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.1.</span> <span class="nav-text">模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">6.2.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.3.</span> <span class="nav-text">内置对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Values"><span class="nav-number">6.4.</span> <span class="nav-text">Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E9%81%93%E4%B8%8E%E5%87%BD%E6%95%B0"><span class="nav-number">6.5.</span> <span class="nav-text">管道与函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="nav-number">6.6.</span> <span class="nav-text">流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#if"><span class="nav-number">6.6.1.</span> <span class="nav-text">if</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#with"><span class="nav-number">6.6.2.</span> <span class="nav-text">with</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#range"><span class="nav-number">6.6.3.</span> <span class="nav-text">range</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">6.7.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.8.</span> <span class="nav-text">命名模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E8%87%AA%E5%B7%B1%E7%9A%84Chart%EF%BC%9AJava%E5%BA%94%E7%94%A8%E4%B8%BA%E4%BE%8B"><span class="nav-number">7.</span> <span class="nav-text">开发自己的Chart：Java应用为例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Harbor%E4%BD%9C%E4%B8%BAChart%E4%BB%93%E5%BA%93"><span class="nav-number">8.</span> <span class="nav-text">使用Harbor作为Chart仓库</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yu Hui</p>
  <div class="site-description" itemprop="description">蠢鱼蠢鱼，上班摸鱼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yu Hui</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'r1qWa79VLJ9QrA5hRBwYhqz9-MdYXbMMI',
      appKey     : 'qehVUkVNSgcNDbhCJx4c2rkk',
      placeholder: "期待你的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
